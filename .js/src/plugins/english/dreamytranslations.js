var t=this&&this.__awaiter||function(t,e,r,n){return new(r||(r=Promise))((function(a,s){function i(t){try{o(n.next(t))}catch(t){s(t)}}function c(t){try{o(n.throw(t))}catch(t){s(t)}}function o(t){var e;t.done?a(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(i,c)}o((n=n.apply(t,e||[])).next())}))},e=this&&this.__generator||function(t,e){var r,n,a,s={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]},i=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return i.next=c(0),i.throw=c(1),i.return=c(2),"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function c(c){return function(o){return function(c){if(r)throw new TypeError("Generator is already executing.");for(;i&&(i=0,c[0]&&(s=0)),s;)try{if(r=1,n&&(a=2&c[0]?n.return:c[0]?n.throw||((a=n.return)&&a.call(n),0):n.next)&&!(a=a.call(n,c[1])).done)return a;switch(n=0,a&&(c=[2&c[0],a.value]),c[0]){case 0:case 1:a=c;break;case 4:return s.label++,{value:c[1],done:!1};case 5:s.label++,n=c[1],c=[0];continue;case 7:c=s.ops.pop(),s.trys.pop();continue;default:if(!(a=s.trys,(a=a.length>0&&a[a.length-1])||6!==c[0]&&2!==c[0])){s=0;continue}if(3===c[0]&&(!a||c[1]>a[0]&&c[1]<a[3])){s.label=c[1];break}if(6===c[0]&&s.label<a[1]){s.label=a[1],a=c;break}if(a&&s.label<a[2]){s.label=a[2],s.ops.push(c);break}a[2]&&s.ops.pop(),s.trys.pop();continue}c=e.call(t,s)}catch(t){c=[6,t],n=0}finally{r=a=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}([c,o])}}};Object.defineProperty(exports,"__esModule",{value:!0});var r=require("cheerio"),n=require("@libs/fetch"),a=require("@libs/novelStatus"),s=require("@libs/filterInputs"),i=function(){function i(){this.id="dreamytranslations",this.name="Dreamy Translations",this.version="1.1.0",this.icon="src/en/dreamytranslations/icon.png",this.site="https://dreamy-translations.com/",this.filters={sort:{label:"Sort By",value:"title",options:[{label:"Title",value:"title"},{label:"Chapters",value:"chapters"},{label:"Views",value:"views"},{label:"Updates",value:"updates"},{label:"Illustrations",value:"illustrations"}],type:s.FilterTypes.Picker},illustrated:{label:"Illustrated Only",value:!1,type:s.FilterTypes.Switch}}}return i.prototype.popularNovels=function(r,a){return t(this,void 0,void 0,(function(){var t,s,i,c,o,l,u,p,h,f,d,v,m,g,b,y,w,x,C,I,N,j,_,A,S,J,k,T,O,U,q,L=this;return e(this,(function(e){switch(e.label){case 0:return 1!==r?[2,[]]:(t="title",s=!1,(null==a?void 0:a.showLatestNovels)?t="updates":(null===(O=null===(T=null==a?void 0:a.filters)||void 0===T?void 0:T.sort)||void 0===O?void 0:O.value)&&(t=a.filters.sort.value,s=null!==(q=null===(U=a.filters.illustrated)||void 0===U?void 0:U.value)&&void 0!==q&&q),i="".concat(this.site,"series"),[4,(0,n.fetchApi)(i)]);case 1:return[4,e.sent().text()];case 2:if(c=e.sent(),o=null,!(s||"illustrations"===t))return[3,8];e.label=3;case 3:return e.trys.push([3,7,,8]),[4,(0,n.fetchApi)("".concat(this.site,"api/illustration-counts"),{headers:{Accept:"application/json",Referer:this.site}})];case 4:return(l=e.sent()).ok?[4,l.json()]:[3,6];case 5:u=e.sent(),o=u.counts||{},e.label=6;case 6:return[3,8];case 7:return e.sent(),[3,8];case 8:for(p=[],h=c.match(/\\"id\\":\d+,\\"title\\":\\"[^\\]+\\",\\"slug\\":\\"[^\\]+\\"/g)||[],f=0,d=h;f<d.length;f++)v=d[f],m=v.match(/\\"id\\":(\d+)/),g=v.match(/\\"title\\":\\"([^\\]+)\\"/),b=v.match(/\\"slug\\":\\"([^\\]+)\\"/),m&&g&&b&&(y=m[1],w=this.unescapeJson(g[1]),x=b[1],C=c.indexOf(v),I=c.substring(C,C+2e3),N=I.match(/\\"total_chapters\\":(\d+)/),j=I.match(/\\"view_count\\":(\d+)/),_=I.match(/\\"last_updated_at\\":\\"([^"\\]+)\\"/),A=I.match(/\\"cover\\":\\"(https:[^"\\]+)\\"/),p.push({id:y,title:w,slug:x,cover:A?A[1].replace(/\\\//g,"/"):"https://supabase.dreamy-translations.com/storage/v1/object/public/covers/".concat(y,"/cover.jpeg"),totalChapters:N?parseInt(N[1]):0,viewCount:j?parseInt(j[1]):0,lastUpdatedAt:_?_[1]:""}));return S=new Set,J=p.filter((function(t){return!S.has(t.slug)&&(S.add(t.slug),!0)})),k=J,s&&o&&(k=J.filter((function(t){return t.id in o}))),k.sort((function(e,r){switch(t){case"chapters":return r.totalChapters-e.totalChapters;case"views":return r.viewCount-e.viewCount;case"updates":return new Date(r.lastUpdatedAt).getTime()-new Date(e.lastUpdatedAt).getTime();case"illustrations":return((null==o?void 0:o[r.id])||0)-((null==o?void 0:o[e.id])||0);default:return e.title.localeCompare(r.title)}})),[2,k.map((function(t){var e=null==o?void 0:o[t.id];return{name:(e?"(ðŸ–¼ï¸".concat(e,") "):"")+L.decodeHtmlEntities(t.title),path:"novel/".concat(t.slug),cover:t.cover}}))]}}))}))},i.prototype.parseNovel=function(r){return t(this,void 0,void 0,(function(){var t,s,i,c,o,l,u,p,h,f,d,v,m,g,b,y,w,x,C,I,N,j,_,A,S,J,k,T,O,U,q,L,D;return e(this,(function(e){switch(e.label){case 0:return t="".concat(this.site).concat(r),[4,(0,n.fetchApi)(t)];case 1:return[4,e.sent().text()];case 2:for(s=e.sent(),i={path:r,name:"Untitled"},s.match(/\\"project\\":\s*\{\\"id\\":\s*(\d+)/),c=s.match(/\\"title\\":\\"([^\\]+)\\"/),o=s.match(/\\"synopsis\\":\\"(.*?)\\",\\"short_synopsis\\"/),c&&(i.name=this.unescapeJson(c[1])),o&&(i.summary=this.unescapeJson(o[1])),l=s.match(/\\"cover\\":\\"(https:[^"\\]+)\\"/),u=s.match(/\\"coverUrl\\":\\"(https:[^"\\]+)\\"/),l?i.cover=this.unescapeJson(l[1]):u&&(i.cover=this.unescapeJson(u[1])),(p=s.match(/\\"author\\":\\"([^\\]+)\\"/))&&(i.author=p[1]),(h=s.match(/\\"genres\\":\s*\[([^\]]+)\]/))&&(f=h[1].match(/\\"([^\\]+)\\"/g))&&(i.genres=f.map((function(t){return t.replace(/\\"/g,"")})).join(", ")),i.status=a.NovelStatus.Ongoing,d=new Set,v=s.match(/\\"chapterIndex\\":\d+/g)||[],m=0,g=v;m<g.length;m++)b=g[m],(y=b.match(/(\d+)/))&&d.add(parseInt(y[1]));for(w=[],x=r.replace("novel/",""),C=s.match(/\{\\"id\\":\d+,\\"title\\":\\"[^\\]+\\",\\"slug\\":\\"[^\\]+\\",\\"index\\":\d+,\\"free\\":(true|false),\\"status\\":\\"[^\\]+\\"/g)||[],I=0,N=C;I<N.length;I++)j=N[I],_=j.match(/\\"title\\":\\"([^\\]+)\\"/),A=j.match(/\\"index\\":(\d+)/),S=j.match(/\\"status\\":\\"([^\\]+)\\"/),_&&A&&S&&(J=_[1],k=A[1],T=S[1],O=parseInt(k),"published"===T&&(U=d.has(O),q=U?"ðŸ–¼ï¸ ":"",L=this.unescapeJson(J).replace(/\s*\(Illustration\)\s*$/i,""),w.push({name:"".concat(q,"Chapter ").concat(O,": ").concat(L),path:"novel/".concat(x,"/chapter/").concat(O),chapterNumber:O})));return(D=w.filter((function(t,e,r){return e===r.findIndex((function(e){return e.chapterNumber===t.chapterNumber}))}))).sort((function(t,e){return(t.chapterNumber||0)-(e.chapterNumber||0)})),i.chapters=D,[2,i]}}))}))},i.prototype.parseChapter=function(a){return t(this,void 0,void 0,(function(){var t,s,i,c,o,l;return e(this,(function(e){switch(e.label){case 0:return t="".concat(this.site).concat(a),[4,(0,n.fetchApi)(t)];case 1:return[4,e.sent().text()];case 2:return s=e.sent(),i=(0,r.load)(s),(c=i('[class*="prose"]').first()).length&&(c.find('nav, button, [class*="navigation"], a[href*="/chapter/"], .flex.items-center.justify-between, [class*="sticky"], [class*="fixed"]').remove(),(o=(o=c.html()||"").replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi,"").replace(/<style\b[^<]*(?:(?!<\/style>)<[^<]*)*<\/style>/gi,"").trim()).length>100)?[2,o]:(l=s.match(/\\"content\\":\\"((?:[^"\\]|\\.)*)\\"/))&&l[1].length>100?[2,this.unescapeJson(l[1]).split("\n\n").filter((function(t){return t.trim()})).map((function(t){return"<p>".concat(t.trim(),"</p>")})).join("\n")]:[2,"Chapter content not available."]}}))}))},i.prototype.searchNovels=function(r,n){return t(this,void 0,void 0,(function(){var t,a;return e(this,(function(e){switch(e.label){case 0:return 1!==n?[2,[]]:[4,this.popularNovels(1,{showLatestNovels:!1,filters:this.filters})];case 1:return t=e.sent(),a=r.toLowerCase(),[2,t.filter((function(t){return t.name.toLowerCase().includes(a)}))]}}))}))},i.prototype.decodeHtmlEntities=function(t){return t.replace(/&#x27;/g,"'").replace(/&quot;/g,'"').replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">")},i.prototype.unescapeJson=function(t){return t.replace(/\\\\n/g,"\n").replace(/\\\\r/g,"\r").replace(/\\\\t/g,"\t").replace(/\\\\"/g,'"').replace(/\\\\\\\\/g,"\\\\").replace(/\\n/g,"\n").replace(/\\r/g,"\r").replace(/\\t/g,"\t").replace(/\\"/g,'"').replace(/\\\\/g,"\\").replace(/\\u([0-9a-fA-F]{4})/g,(function(t,e){return String.fromCharCode(parseInt(e,16))}))},i}();exports.default=new i;